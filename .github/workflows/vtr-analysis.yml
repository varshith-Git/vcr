name: VTR Analysis (Observational)

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  vtr-analysis:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
      
      - name: Build VTR
        run: cargo build --release --bin vtr
      
      - name: Run VTR ingestion
        id: ingest
        run: |
          ./target/release/vtr ingest src/ > vtr-results.json
          cat vtr-results.json
        continue-on-error: true
      
      - name: Verify determinism
        id: verify
        run: |
          ./target/release/vtr ingest src/ > vtr-verify.json
          diff vtr-results.json vtr-verify.json && echo "✓ Determinism verified" || echo "✗ Hash mismatch!"
        continue-on-error: true
      
      - name: Save snapshot
        run: |
          ./target/release/vtr snapshot save > snapshot-info.json
          cat snapshot-info.json
        continue-on-error: true
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: vtr-analysis-results
          path: |
            vtr-results.json
            vtr-verify.json
            snapshot-info.json
          retention-days: 30
      
      - name: Report status
        run: |
          echo "## VTR Analysis Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Ingestion**: $(jq -r '.status' vtr-results.json)" >> $GITHUB_STEP_SUMMARY
          echo "**CPG Hash**: $(jq -r '.cpg_hash' vtr-results.json)" >> $GITHUB_STEP_SUMMARY
          echo "**Nodes**: $(jq -r '.nodes' vtr-results.json)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Determinism**: $(diff -q vtr-results.json vtr-verify.json && echo '✓ Verified' || echo '✗ Failed')" >> $GITHUB_STEP_SUMMARY

name: VTR Analysis (Observational)

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  vtr-analysis:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
      
      - name: Build VCR
        run: cargo build --release --bin vcr
      
      - name: Run VCR ingestion
        id: ingest
        run: |
          ./target/release/vcr ingest src/lib.rs > vcr-results.json
          cat vcr-results.json
        continue-on-error: true
      
      - name: Verify determinism
        id: verify
        run: |
          ./target/release/vcr ingest src/lib.rs > vcr-verify.json
          diff vcr-results.json vcr-verify.json && echo "✓ Determinism verified" || echo "✗ Hash mismatch!"
        continue-on-error: true
      
      - name: Save snapshot
        run: |
          ./target/release/vcr snapshot save > snapshot-info.json
          cat snapshot-info.json
        continue-on-error: true
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: vcr-analysis-results
          path: |
            vcr-results.json
            vcr-verify.json
            snapshot-info.json
          retention-days: 30
      
      - name: Report status
        run: |
          echo "## VCR Analysis Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Ingestion**: $(jq -r '.status' vcr-results.json)" >> $GITHUB_STEP_SUMMARY
          echo "**CPG Hash**: $(jq -r '.cpg_hash' vcr-results.json)" >> $GITHUB_STEP_SUMMARY
          echo "**Nodes**: $(jq -r '.nodes' vcr-results.json)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Determinism**: $(diff -q vcr-results.json vcr-verify.json && echo '✓ Verified' || echo '✗ Failed')" >> $GITHUB_STEP_SUMMARY
